#!/bin/bash

src_files=`ls original/*.pdf`

for src in $src_files
do
    dest=`echo "$src" | cut -d '/' -f 2`
    mkdir -p uncompress
    if [ ! -e uncompress/$dest ]; then
	pdftk "$src" output "uncompress/$dest" uncompress
    fi

    dest=`echo "$src" | cut -d '/' -f 2 | awk -F '.' '{print $1}'`
    rm -rf split/${dest}

    OLD=""
    NEW=""
    verify=""
    val=1

    while read p
    do
	NEW=$p

	if [ "X$OLD" != "X" ] && [ "X$NEW" != "X" ]; then
	    mkdir -p split/${dest}
	    pdftk "uncompress/${dest}.pdf" cat $OLD-$NEW output \
		"split/${dest}/${val}.pdf" uncompress
	    val=$(( $val + 1))
	fi

	OLD=$NEW

	verify="$verify $OLD"
    done < pages/$dest.txt
    val=$(( $val - 1))

    mkdir -p questions
    touch questions/${dest}.txt
    if [ $val -gt 0 ]; then
	echo ${dest}: $val Chapters created!
	pdftk "uncompress/${dest}.pdf" cat $verify output \
	    "split/${dest}/verify.pdf" uncompress
    fi
done
